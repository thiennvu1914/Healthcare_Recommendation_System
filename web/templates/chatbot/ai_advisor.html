{% extends 'chatbot/base.html' %}
{% load static %}

{% block title %}AI Tư vấn - Healthcare Portal{% endblock %}

{% block extra_css %}
<style>
    /* Hide floating chatbot widget on AI Advisor page */
    .chatbot-widget {
        display: none !important;
    }
    
    body {
        background: var(--light-bg);
    }
    
    .chat-page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 40px 0;
        margin-bottom: 30px;
    }
    
    .chat-container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 600px;
    }
    
    .chat-header {
        background: linear-gradient(135deg, var(--primary-color), #0052a3);
        color: white;
        padding: 20px 25px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .chat-header h5 {
        margin: 0;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .status-indicator {
        width: 10px;
        height: 10px;
        background: #28a745;
        border-radius: 50%;
        display: inline-block;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 25px;
        background: var(--light-bg);
    }
    
    .message {
        display: flex;
        margin-bottom: 20px;
        animation: slideIn 0.3s;
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .message.user {
        justify-content: flex-end;
    }
    
    .message-content {
        max-width: 70%;
        padding: 15px 20px;
        border-radius: 18px;
        word-wrap: break-word;
        white-space: pre-wrap;
    }
    
    .message.user .message-content {
        background: var(--primary-color);
        color: white;
        border-bottom-right-radius: 4px;
    }
    
    .message.bot .message-content {
        background: white;
        color: #333;
        border-bottom-left-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        flex-shrink: 0;
    }
    
    .message.user .avatar {
        background: var(--primary-color);
        color: white;
        margin-left: 12px;
    }
    
    .message.bot .avatar {
        background: #f0f0f0;
        color: white;
        margin-right: 12px;
        padding: 0;
        overflow: hidden;
    }
    
    .message.bot .avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .welcome-message {
        text-align: center;
        padding: 60px 20px;
        color: #666;
    }
    
    .welcome-message i {
        font-size: 5rem;
        color: var(--primary-color);
        margin-bottom: 20px;
    }
    
    .welcome-message h4 {
        color: #333;
        margin-bottom: 15px;
        font-size: 1.5rem;
    }
    
    .quick-questions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin-top: 30px;
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
    }
    
    .quick-question-btn {
        background: white;
        border: 2px solid var(--primary-color);
        color: var(--primary-color);
        padding: 15px 20px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 0.95rem;
        text-align: left;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .quick-question-btn:hover {
        background: var(--primary-color);
        color: white;
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0,102,204,0.3);
    }
    
    .quick-question-btn i {
        font-size: 1.2rem;
    }
    
    .typing-indicator {
        display: none;
        padding: 15px 20px;
        background: white;
        border-radius: 18px;
        border-bottom-left-radius: 4px;
        max-width: 70px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .typing-indicator.show {
        display: inline-block;
    }
    
    .typing-dots {
        display: flex;
        gap: 4px;
    }
    
    .typing-dots span {
        width: 8px;
        height: 8px;
        background: #999;
        border-radius: 50%;
        animation: typing 1.4s infinite;
    }
    
    .typing-dots span:nth-child(2) {
        animation-delay: 0.2s;
    }
    
    .typing-dots span:nth-child(3) {
        animation-delay: 0.4s;
    }
    
    @keyframes typing {
        0%, 60%, 100% {
            transform: translateY(0);
        }
        30% {
            transform: translateY(-10px);
        }
    }
    
    .chat-input-area {
        padding: 20px 25px;
        background: white;
        border-top: 1px solid #e9ecef;
    }
    
    .chat-input-wrapper {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    .chat-input {
        flex: 1;
        border: 2px solid #e9ecef;
        border-radius: 25px;
        padding: 12px 20px;
        font-size: 1rem;
        transition: all 0.3s;
    }
    
    .chat-input:focus {
        border-color: var(--primary-color);
        outline: none;
        box-shadow: 0 0 0 3px rgba(0,102,204,0.1);
    }
    
    .send-btn, .clear-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .send-btn {
        background: var(--primary-color);
        color: white;
    }
    
    .send-btn:hover:not(:disabled) {
        background: #0052a3;
        transform: scale(1.1);
    }
    
    .send-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }
    
    .clear-btn {
        background: #6c757d;
        color: white;
    }
    
    .clear-btn:hover {
        background: #5a6268;
        transform: scale(1.1);
    }
    
    .chat-messages::-webkit-scrollbar {
        width: 8px;
    }
    
    .chat-messages::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    
    .chat-messages::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }
    
    .chat-messages::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
    
    .source-item {
        margin-bottom: 12px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 3px solid #0066cc;
    }
    
    .source-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-right: 6px;
    }
    
    .source-badge.qa {
        background: #28a745;
        color: white;
    }
    
    .source-badge.article {
        background: #0066cc;
        color: white;
    }
    
    .source-link {
        color: #0066cc;
        text-decoration: none;
        font-size: 0.85rem;
        margin-left: 6px;
    }
    
    .source-link:hover {
        text-decoration: underline;
    }
    
    .permanent-disclaimer {
        background: linear-gradient(135deg, #fff3cd 0%, #fff8e1 100%);
        border: 2px solid #ffc107;
        border-radius: 15px;
        padding: 20px;
        margin-top: 25px;
        box-shadow: 0 4px 12px rgba(255, 193, 7, 0.2);
    }
    
    .permanent-disclaimer h6 {
        color: #856404;
        margin-bottom: 12px;
        font-weight: 700;
    }
    
    .permanent-disclaimer p {
        color: #856404;
        margin-bottom: 8px;
        font-size: 0.95rem;
    }
    
    .permanent-disclaimer .emergency {
        background: #fff;
        padding: 12px;
        border-radius: 8px;
        margin-top: 10px;
        border-left: 4px solid #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="chat-page-header">
    <div class="container text-center">
        <h1 class="display-5 fw-bold mb-3">
            <i class="bi bi-robot"></i> AI Tư vấn Sức khỏe
        </h1>
        <p class="lead">
            Đặt câu hỏi cho AI được huấn luyện trên 148,000+ tài liệu y tế tiếng Việt
        </p>
    </div>
</div>

<!-- Chat Container -->
<div class="container pb-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="chat-container">
                <!-- Chat Header -->
                <div class="chat-header">
                    <h5>
                        <i class="bi bi-chat-heart-fill"></i>
                        Healthcare AI Assistant
                        <span class="status-indicator"></span>
                    </h5>
                    <button class="clear-btn" onclick="clearChat()" title="Xóa cuộc trò chuyện">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                
                <!-- Chat Messages -->
                <div class="chat-messages" id="chatMessages">
                    <div class="welcome-message">
                        <i class="bi bi-robot"></i>
                        <h4>Tôi là trợ lý AI y tế</h4>
                        <p>Hãy đặt câu hỏi về sức khỏe của bạn, tôi sẽ cố gắng hỗ trợ tốt nhất.</p>
                        
                        <div class="quick-questions">
                            <button class="quick-question-btn" onclick="askQuestion('Làm thế nào để phòng ngừa cảm cúm?')">
                                <i class="bi bi-thermometer"></i>
                                <span>Phòng ngừa cảm cúm</span>
                            </button>
                            <button class="quick-question-btn" onclick="askQuestion('Chế độ ăn cho người tiểu đường?')">
                                <i class="bi bi-heart-pulse"></i>
                                <span>Chế độ ăn tiểu đường</span>
                            </button>
                            <button class="quick-question-btn" onclick="askQuestion('Cách giảm huyết áp tự nhiên?')">
                                <i class="bi bi-activity"></i>
                                <span>Giảm huyết áp</span>
                            </button>
                            <button class="quick-question-btn" onclick="askQuestion('Triệu chứng viêm gan B là gì?')">
                                <i class="bi bi-hospital"></i>
                                <span>Triệu chứng viêm gan</span>
                            </button>
                            <button class="quick-question-btn" onclick="askQuestion('Cách tăng cường miễn dịch tự nhiên?')">
                                <i class="bi bi-shield-plus"></i>
                                <span>Tăng cường miễn dịch</span>
                            </button>
                            <button class="quick-question-btn" onclick="askQuestion('Triệu chứng đau dạ dày cần lưu ý?')">
                                <i class="bi bi-capsule"></i>
                                <span>Triệu chứng đau dạ dày</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Chat Input -->
                <div class="chat-input-area">
                    <div class="chat-input-wrapper">
                        <input 
                            type="text" 
                            class="chat-input" 
                            id="userInput" 
                            placeholder="Nhập câu hỏi của bạn..."
                            onkeypress="if(event.key === 'Enter') sendMessage()"
                        >
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                            <i class="bi bi-send-fill"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Source Citation Modal -->
            <div class="modal fade" id="sourceModal" tabindex="-1" aria-labelledby="sourceModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="sourceModalLabel">
                                <i class="bi bi-file-text"></i> Chi tiết nguồn tham khảo
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body" id="sourceModalBody">
                            <!-- Content will be populated by JavaScript -->
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Permanent Disclaimer -->
            <div class="permanent-disclaimer">
                <h6>
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    Lưu ý quan trọng
                </h6>
                <p>
                    <i class="bi bi-info-circle"></i>
                    Thông tin từ AI chỉ mang tính chất tham khảo, dựa trên cơ sở dữ liệu y tế.
                    Bạn nên đi khám trực tiếp để được tư vấn chính xác hơn.
                </p>
                <p>
                    <i class="bi bi-shield-exclamation"></i>
                    Hệ thống này KHÔNG thay thế cho ý kiến của bác sĩ chuyên khoa.
                </p>
                <div class="emergency">
                    <strong>
                        <i class="bi bi-telephone-fill text-danger"></i>
                        Trường hợp khẩn cấp:
                    </strong>
                    Hãy gọi <strong class="text-danger">115</strong> hoặc đến bệnh viện ngay lập tức.
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const chatMessages = document.getElementById('chatMessages');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    
    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
    
    function addMessage(content, isUser) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
        
        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.innerHTML = isUser ? '<i class="bi bi-person-fill"></i>' : '<img src="{% static "chatbot/images/avt_ai_doctor.png" %}" alt="AI Doctor">';
        
        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';
        messageContent.textContent = content == null ? '' : String(content);
        
        if (isUser) {
            messageDiv.appendChild(messageContent);
            messageDiv.appendChild(avatar);
        } else {
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
        }
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function addInitialGreeting() {
        if (chatMessages.dataset.greeted === '1') return;

        const messageDiv = document.createElement('div');
        messageDiv.className = 'message bot';

        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.innerHTML = '<img src="{% static "chatbot/images/avt_ai_doctor.png" %}" alt="AI Doctor">';

        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';
        messageContent.textContent = 'Xin chào! Bạn hãy mô tả triệu chứng, thời gian xuất hiện và dấu hiệu kèm theo (sốt, nôn, tiêu chảy...) để mình tư vấn tốt hơn.';

        messageDiv.appendChild(avatar);
        messageDiv.appendChild(messageContent);

        // Put greeting at the top so it remains even after the welcome card is removed.
        chatMessages.insertBefore(messageDiv, chatMessages.firstChild);
        chatMessages.dataset.greeted = '1';
    }

    function addBotResponse(data) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message bot';

        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.innerHTML = '<img src="{% static "chatbot/images/avt_ai_doctor.png" %}" alt="AI Doctor">';

        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';

        const wrapper = document.createElement('div');
        wrapper.className = 'd-flex flex-column gap-2';

        // 1) Specialty box (skip for non-medical responses)
        const specialty = (data && data.specialty) ? String(data.specialty) : 'Y tế tổng quát';
        if (specialty !== 'Trợ lý AI') {
            const specialtyRow = document.createElement('div');
            const specialtyBadge = document.createElement('span');
            specialtyBadge.className = 'badge bg-primary';
            specialtyBadge.textContent = `Chuyên khoa: ${specialty}`;
            specialtyRow.appendChild(specialtyBadge);
            wrapper.appendChild(specialtyRow);
        }

        // 2) AI answer
        const answerBlock = document.createElement('div');
        answerBlock.style.marginTop = '10px';
        const answerLabel = document.createElement('div');
        answerLabel.className = 'fw-semibold mb-2';
        answerLabel.innerHTML = '<i class="bi bi-chat-square-text"></i> Câu trả lời:';
        const answerText = document.createElement('div');
        answerText.style.whiteSpace = 'pre-wrap';
        answerText.style.lineHeight = '1.6';
        answerText.textContent = (data && data.answer != null) ? String(data.answer) : '';
        answerBlock.appendChild(answerLabel);
        answerBlock.appendChild(answerText);
        wrapper.appendChild(answerBlock);

        // 3) Top sources with badges and links (only for medical queries)
        const sources = (data && Array.isArray(data.sources)) ? data.sources : [];
        if (sources.length > 0 && specialty !== 'Trợ lý AI') {
            const sourcesBlock = document.createElement('div');
            sourcesBlock.style.marginTop = '15px';
            const sourcesLabel = document.createElement('div');
            sourcesLabel.className = 'fw-semibold mb-2';
            sourcesLabel.innerHTML = '<i class="bi bi-folder2-open"></i> Thông tin liên quan (Top):';
            sourcesBlock.appendChild(sourcesLabel);

            for (const s of sources.slice(0, 5)) {
                const sourceItem = document.createElement('div');
                sourceItem.className = 'source-item';
                
                const type = (s && s.type) ? String(s.type) : '';
                const title = (s && s.title) ? String(s.title) : '';
                const question = (s && s.question) ? String(s.question) : '';
                const snippet = (s && s.snippet) ? String(s.snippet) : '';
                const source_id = (s && s.id) ? String(s.id) : '';
                
                // Create badge
                const badge = document.createElement('span');
                badge.className = type === 'article' ? 'source-badge article' : 'source-badge qa';
                badge.textContent = type === 'article' ? 'Article' : 'Q&A';
                
                // Create content
                const content = document.createElement('span');
                const mainText = type === 'article' ? title : question;
                content.textContent = snippet ? `${mainText} — ${snippet}` : mainText;
                
                // Create citation link
                const link = document.createElement('a');
                link.className = 'source-link';
                link.href = '#';
                link.textContent = '[Trích dẫn]';
                link.onclick = (e) => {
                    e.preventDefault();
                    showSourceDetail(s);
                };
                
                sourceItem.appendChild(badge);
                sourceItem.appendChild(content);
                sourceItem.appendChild(link);
                sourcesBlock.appendChild(sourceItem);
            }
            
            wrapper.appendChild(sourcesBlock);
        }

        messageContent.appendChild(wrapper);

        messageDiv.appendChild(avatar);
        messageDiv.appendChild(messageContent);

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    function showTyping() {
        const typingDiv = document.createElement('div');
        typingDiv.className = 'message bot';
        typingDiv.id = 'typingIndicator';
        
        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.innerHTML = '<img src="{% static "chatbot/images/avt_ai_doctor.png" %}" alt="AI Doctor">';
        
        const typingIndicator = document.createElement('div');
        typingIndicator.className = 'typing-indicator show';
        typingIndicator.innerHTML = `
            <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        `;
        
        typingDiv.appendChild(avatar);
        typingDiv.appendChild(typingIndicator);
        chatMessages.appendChild(typingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    function hideTyping() {
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }
    
    function showSourceDetail(source) {
        const modalBody = document.getElementById('sourceModalBody');
        const type = source.type || '';
        const isArticle = type === 'article';
        
        let html = '<div class="source-detail">';
        
        // Badge
        html += `<div class="mb-3">
            <span class="source-badge ${isArticle ? 'article' : 'qa'}" style="font-size: 1rem; padding: 6px 12px;">
                ${isArticle ? 'Bài viết (Article)' : 'Hỏi đáp (Q&A)'}
            </span>
        </div>`;
        
        // ID
        if (source.id) {
            html += `<p><strong><i class="bi bi-hash"></i> ID:</strong> <code>${source.id}</code></p>`;
        }
        
        // Title or Question
        if (isArticle && source.title) {
            html += `<h6 class="text-primary"><i class="bi bi-file-text"></i> Tiêu đề:</h6>
                     <p>${source.title}</p>`;
        } else if (!isArticle && source.question) {
            html += `<h6 class="text-success"><i class="bi bi-question-circle"></i> Câu hỏi:</h6>
                     <p>${source.question}</p>`;
        }
        
        // Score
        if (source.score !== undefined) {
            const scorePercent = (source.score * 100).toFixed(1);
            html += `<p><strong><i class="bi bi-graph-up"></i> Độ liên quan:</strong> 
                     <span class="badge bg-info">${scorePercent}%</span></p>`;
        }
        
        // Content based on type
        if (isArticle) {
            // Article: show link
            if (source.link) {
                html += `<h6 class="mt-3"><i class="bi bi-link-45deg"></i> Nguồn bài viết:</h6>
                         <div class="p-3 bg-light border-start border-success border-4 rounded">
                             <a href="${source.link}" target="_blank" class="btn btn-outline-primary">
                                 <i class="bi bi-box-arrow-up-right"></i> Mở bài viết gốc
                             </a>
                             <div class="mt-2 small text-muted" style="word-break: break-all;">${source.link}</div>
                         </div>`;
            } else {
                html += `<p class="text-muted"><i class="bi bi-info-circle"></i> Không có link bài viết gốc</p>`;
            }
        } else {
            // Q&A: show full question and answer
            if (source.full_answer) {
                html += `<h6 class="mt-3"><i class="bi bi-chat-left-text"></i> Câu trả lời đầy đủ:</h6>
                         <div class="p-3 bg-light border-start border-success border-4 rounded" style="white-space: pre-wrap; max-height: 400px; overflow-y: auto;">
                             ${source.full_answer}
                         </div>`;
            } else if (source.snippet) {
                html += `<h6 class="mt-3"><i class="bi bi-text-paragraph"></i> Nội dung trích xuất:</h6>
                         <div class="p-3 bg-light border-start border-primary border-4 rounded" style="white-space: pre-wrap;">
                             ${source.snippet}
                         </div>`;
            }
        }
        
        html += '</div>';
        
        modalBody.innerHTML = html;
        
        // Show modal using Bootstrap 5
        const modal = new bootstrap.Modal(document.getElementById('sourceModal'));
        modal.show();
    }
    
    async function sendMessage() {
        const query = userInput.value.trim();
        if (!query) return;
        
        // Remove welcome message if exists
        const welcomeMsg = chatMessages.querySelector('.welcome-message');
        if (welcomeMsg) {
            welcomeMsg.remove();
        }
        
        addMessage(query, true);
        userInput.value = '';
        userInput.disabled = true;
        sendBtn.disabled = true;
        
        showTyping();
        
        try {
            const response = await fetch('http://localhost:8000/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ query: query })
            });
            
            hideTyping();
            
            if (response.ok) {
                const data = await response.json();
                if (data && (data.specialty || data.sources || data.disclaimer)) {
                    addBotResponse(data);
                } else {
                    addMessage(data.answer, false);
                }
            } else {
                const error = await response.json();
                addMessage(`⚠️ Lỗi: ${error.error || 'Không thể kết nối đến server'}`, false);
            }
        } catch (error) {
            hideTyping();
            addMessage(`⚠️ Lỗi kết nối: ${error.message}. Vui lòng kiểm tra API server.`, false);
        } finally {
            userInput.disabled = false;
            sendBtn.disabled = false;
            userInput.focus();
        }
    }
    
    function askQuestion(question) {
        userInput.value = question;
        sendMessage();
    }
    
    function clearChat() {
        if (confirm('Bạn có chắc muốn xóa toàn bộ cuộc trò chuyện?')) {
            chatMessages.dataset.greeted = '0';
            chatMessages.innerHTML = `
                <div class="welcome-message">
                    <i class="bi bi-robot"></i>
                    <h4>Tôi là trợ lý AI y tế</h4>
                    <p>Hãy đặt câu hỏi về sức khỏe của bạn, tôi sẽ cố gắng hỗ trợ tốt nhất.</p>
                    
                    <div class="quick-questions">
                        <button class="quick-question-btn" onclick="askQuestion('Làm thế nào để phòng ngừa cảm cúm?')">
                            <i class="bi bi-thermometer"></i>
                            <span>Phòng ngừa cảm cúm</span>
                        </button>
                        <button class="quick-question-btn" onclick="askQuestion('Chế độ ăn cho người tiểu đường?')">
                            <i class="bi bi-heart-pulse"></i>
                            <span>Chế độ ăn tiểu đường</span>
                        </button>
                        <button class="quick-question-btn" onclick="askQuestion('Cách giảm huyết áp tự nhiên?')">
                            <i class="bi bi-activity"></i>
                            <span>Giảm huyết áp</span>
                        </button>
                        <button class="quick-question-btn" onclick="askQuestion('Triệu chứng viêm gan B là gì?')">
                            <i class="bi bi-hospital"></i>
                            <span>Triệu chứng viêm gan</span>
                        </button>
                        <button class="quick-question-btn" onclick="askQuestion('Cách tăng cường miễn dịch tự nhiên?')">
                            <i class="bi bi-shield-plus"></i>
                            <span>Tăng cường miễn dịch</span>
                        </button>
                        <button class="quick-question-btn" onclick="askQuestion('Triệu chứng đau dạ dày cần lưu ý?')">
                            <i class="bi bi-capsule"></i>
                            <span>Triệu chứng đau dạ dày</span>
                        </button>
                    </div>
                </div>
            `;

            addInitialGreeting();
        }
    }
    
    // Check API health on load
    window.addEventListener('load', async () => {
        addInitialGreeting();
        try {
            const response = await fetch('http://localhost:8000/api/health');
            const data = await response.json();
            console.log('API Health:', data);
        } catch (error) {
            console.error('API Health Check Failed:', error);
        }
    });
    
    // Auto-focus input
    userInput.focus();
</script>
{% endblock %}

{% extends "healthcare/base.html" %}

{% block title %}{{ page_title }} - H·ªá Th·ªëng T∆∞ V·∫•n Y T·∫ø{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Header Section -->
    <div class="row mb-5">
        <div class="col-lg-10 mx-auto text-center">
            <h1 class="display-5 mb-3">
                <i class="bi bi-cpu text-primary"></i> 
                Tr·ª£ L√Ω S·ª©c Kh·ªèe AI
            </h1>
            <p class="lead text-muted">
                H·ªá th·ªëng t∆∞ v·∫•n s·ª©c kh·ªèe th√¥ng minh d·ª±a tr√™n h∆°n 73,000 c√¢u h·ªèi-tr·∫£ l·ªùi c·ªßa b√°c sƒ© v√† 300+ b√†i vi·∫øt y t·∫ø
            </p>
        </div>
    </div>

    <!-- Main Interface -->
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <!-- Query Input Card -->
            <div class="card shadow-lg mb-4">
                <div class="card-body p-4">
                    <h5 class="card-title mb-4">
                        <i class="bi bi-chat-dots"></i> H·ªèi ƒë√°p s·ª©c kh·ªèe
                    </h5>
                    
                    <!-- Query Form -->
                    <div class="mb-4">
                        <textarea 
                            id="queryInput" 
                            class="form-control form-control-lg" 
                            rows="3" 
                            placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n v·ªÅ s·ª©c kh·ªèe...&#10;V√≠ d·ª•: 'B√© b·ªã s·ªët 38 ƒë·ªô ph·∫£i l√†m sao?'"
                        ></textarea>
                    </div>

                    <!-- Mode Selection -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i class="bi bi-gear"></i> Ch·∫ø ƒë·ªô t∆∞ v·∫•n
                            </label>
                            <select id="modeSelect" class="form-select">
                                <option value="action_filtered" selected>
                                    üéØ Khuy·∫øn ngh·ªã h√†nh ƒë·ªông (Khuy√™n d√πng)
                                </option>
                                <option value="retrieval_only">
                                    üìö T√¨m ki·∫øm Q&A t∆∞∆°ng t·ª±
                                </option>
                                <option value="with_articles">
                                    üìñ ƒê·∫ßy ƒë·ªß (Q&A + B√†i vi·∫øt)
                                </option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i class="bi bi-sliders"></i> S·ªë l∆∞·ª£ng k·∫øt qu·∫£
                            </label>
                            <select id="topKSelect" class="form-select">
                                <option value="3">3 k·∫øt qu·∫£</option>
                                <option value="5" selected>5 k·∫øt qu·∫£</option>
                                <option value="10">10 k·∫øt qu·∫£</option>
                            </select>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="d-grid">
                        <button id="submitBtn" class="btn btn-primary btn-lg">
                            <i class="bi bi-search"></i> Nh·∫≠n t∆∞ v·∫•n
                        </button>
                    </div>

                    <!-- Sample Queries -->
                    <div class="mt-4">
                        <small class="text-muted d-block mb-2">
                            <i class="bi bi-lightbulb"></i> G·ª£i √Ω c√¢u h·ªèi:
                        </small>
                        <div class="d-flex flex-wrap gap-2">
                            {% for sample in sample_queries %}
                            <button class="btn btn-sm btn-outline-secondary sample-query">
                                {{ sample }}
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="text-center my-5" style="display: none;">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">ƒêang x·ª≠ l√Ω...</span>
                </div>
                <p class="mt-3 text-muted">
                    <i class="bi bi-cpu"></i> AI ƒëang ph√¢n t√≠ch c√¢u h·ªèi c·ªßa b·∫°n...
                </p>
            </div>

            <!-- Results Container -->
            <div id="resultsContainer" style="display: none;"></div>
        </div>
    </div>

    <!-- Info Section -->
    <div class="row mt-5">
        <div class="col-lg-10 mx-auto">
            <div class="alert alert-info">
                <h6 class="alert-heading">
                    <i class="bi bi-info-circle"></i> H·ªá th·ªëng ho·∫°t ƒë·ªông nh∆∞ th·∫ø n√†o?
                </h6>
                <ul class="mb-0 small">
                    <li><strong>Retrieval:</strong> T√¨m ki·∫øm c√°c c√¢u h·ªèi-tr·∫£ l·ªùi t∆∞∆°ng t·ª± t·ª´ c∆° s·ªü d·ªØ li·ªáu 73,000+ Q&A c·ªßa b√°c sƒ©</li>
                    <li><strong>Action Extraction:</strong> Tr√≠ch xu·∫•t c√°c h√†nh ƒë·ªông c·ª• th·ªÉ (ƒëi kh√°m, x√©t nghi·ªám, u·ªëng thu·ªëc...)</li>
                    <li><strong>Specialty Detection:</strong> T·ª± ƒë·ªông g·ª£i √Ω chuy√™n khoa ph√π h·ª£p</li>
                    <li><strong>Content Recommendation:</strong> G·ª£i √Ω b√†i vi·∫øt y t·∫ø li√™n quan ƒë·ªÉ ƒë·ªçc th√™m</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const queryInput = document.getElementById('queryInput');
    const modeSelect = document.getElementById('modeSelect');
    const topKSelect = document.getElementById('topKSelect');
    const submitBtn = document.getElementById('submitBtn');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const resultsContainer = document.getElementById('resultsContainer');
    
    // Sample query buttons
    document.querySelectorAll('.sample-query').forEach(btn => {
        btn.addEventListener('click', function() {
            queryInput.value = this.textContent.trim();
            queryInput.focus();
        });
    });
    
    // Submit button
    submitBtn.addEventListener('click', async function() {
        const query = queryInput.value.trim();
        if (!query) {
            alert('Vui l√≤ng nh·∫≠p c√¢u h·ªèi');
            return;
        }
        
        // Show loading
        resultsContainer.style.display = 'none';
        loadingIndicator.style.display = 'block';
        submitBtn.disabled = true;
        
        try {
            // Call API
            const mode = 'rag';  // Always use RAG mode
            const topK = topKSelect.value;
            const response = await fetch(
                `/api/recommend/?query=${encodeURIComponent(query)}&mode=${mode}&top_k=${topK}`
            );
            
            if (!response.ok) {
                throw new Error('L·ªói khi g·ªçi API');
            }
            
            const data = await response.json();
            displayResults(data);
            
        } catch (error) {
            console.error('Error:', error);
            resultsContainer.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    ƒê√£ x·∫£y ra l·ªói khi x·ª≠ l√Ω. Vui l√≤ng th·ª≠ l·∫°i.
                </div>
            `;
            resultsContainer.style.display = 'block';
        } finally {
            loadingIndicator.style.display = 'none';
            submitBtn.disabled = false;
        }
    });
    
    // Enter key to submit
    queryInput.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'Enter') {
            submitBtn.click();
        }
    });
    
    function displayResults(data) {
        let html = '';
        
        // Emergency Warning
        if (data.is_emergency) {
            html += `
                <div class="alert alert-danger shadow-lg mb-4" role="alert">
                    <h4 class="alert-heading">
                        <i class="bi bi-exclamation-triangle-fill"></i> C·∫¢NH B√ÅO C·∫§P C·ª®U
                    </h4>
                    <hr>
                    ${data.summary.replace(/\n/g, '<br>')}
                </div>
            `;
            resultsContainer.innerHTML = html;
            resultsContainer.style.display = 'block';
            return;
        }
        
        // AI Direct Answer (NEW - Most prominent)
        if (data.ai_answer) {
            html += `
                <div class="card shadow-lg mb-4 border-primary" style="border-width: 3px;">
                    <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <h4 class="mb-0">
                            <i class="bi bi-robot"></i> ü§ñ C√¢u tr·∫£ l·ªùi t·ª´ AI
                        </h4>
                    </div>
                    <div class="card-body p-4">
                        <div class="ai-answer-content">
                            ${formatAnswer(data.ai_answer)}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Summary Card
        html += `
            <div class="card shadow mb-4 border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-lightbulb-fill"></i> T√≥m t·∫Øt chi ti·∫øt
                    </h5>
                </div>
                <div class="card-body">
                    <div class="summary-content">
                        ${formatSummary(data.summary)}
                    </div>
                </div>
            </div>
        `;
        
        // Actions
        if (data.actions && data.actions.length > 0) {
            html += `
                <div class="card shadow mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-check-circle"></i> C√°c h√†nh ƒë·ªông ƒë∆∞·ª£c khuy·∫øn ngh·ªã
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush">
            `;
            
            data.actions.forEach((action, index) => {
                const iconClass = action.priority === 'high' ? 'text-danger' : 'text-success';
                const icon = action.type === 'c·∫•p c·ª©u' ? 'exclamation-triangle-fill' : 
                            action.type === 'ƒëi kh√°m' ? 'hospital' :
                            action.type === 'x√©t nghi·ªám' ? 'clipboard-pulse' :
                            action.type === 'u·ªëng thu·ªëc' ? 'capsule' :
                            action.type === 'theo d√µi' ? 'eye' : 'info-circle';
                
                html += `
                    <div class="list-group-item">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-${icon} ${iconClass} me-3 fs-4"></i>
                            <div>
                                <span class="badge bg-secondary mb-2">${action.type}</span>
                                <p class="mb-0">${action.action}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Q&As
        if (data.qas && data.qas.length > 0) {
            html += `
                <div class="card shadow mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-question-circle"></i> 
                            C√¢u h·ªèi t∆∞∆°ng t·ª± (${data.qas.length})
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="accordion" id="qaAccordion">
            `;
            
            data.qas.forEach((qa, index) => {
                const similarity = (qa.similarity * 100).toFixed(0);
                html += `
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button ${index > 0 ? 'collapsed' : ''}" 
                                    type="button" 
                                    data-bs-toggle="collapse" 
                                    data-bs-target="#qa${index}">
                                <div class="w-100">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <span class="fw-bold">Q${qa.qa_id}: ${qa.question.substring(0, 80)}...</span>
                                        <span class="badge bg-success ms-2">${qa.topic}</span>
                                    </div>
                                    <small class="text-muted">ƒê·ªô t∆∞∆°ng ƒë·ªìng: ${similarity}%</small>
                                </div>
                            </button>
                        </h2>
                        <div id="qa${index}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" 
                             data-bs-parent="#qaAccordion">
                            <div class="accordion-body">
                                <p class="mb-2"><strong>C√¢u h·ªèi:</strong> ${qa.question}</p>
                                <hr>
                                <p class="mb-0"><strong>Tr·∫£ l·ªùi:</strong> ${qa.answer}</p>
                                <div class="mt-3">
                                    <a href="/qa/${qa.qa_id}/" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-box-arrow-up-right"></i> Xem chi ti·∫øt
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Articles
        if (data.articles && data.articles.length > 0) {
            html += `
                <div class="card shadow mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="bi bi-file-earmark-text"></i> 
                            B√†i vi·∫øt ƒë·ªçc th√™m (${data.articles.length})
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
            `;
            
            data.articles.forEach(article => {
                html += `
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title">${article.title}</h6>
                                <p class="card-text text-muted small">${article.content.substring(0, 150)}...</p>
                                <a href="${article.link}" target="_blank" class="btn btn-sm btn-primary">
                                    <i class="bi bi-link-45deg"></i> ƒê·ªçc b√†i g·ªëc
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Disclaimer
        html += `
            <div class="alert alert-warning">
                <h6 class="alert-heading">
                    <i class="bi bi-exclamation-triangle"></i> L∆∞u √Ω quan tr·ªçng
                </h6>
                <div class="small">
                    ${data.disclaimer.replace(/\n/g, '<br>')}
                </div>
            </div>
        `;
        
        resultsContainer.innerHTML = html;
        resultsContainer.style.display = 'block';
        
        // Scroll to results
        resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    function formatAnswer(answer) {
        // Format AI answer with better readability
        return answer
            .replace(/\*\*(.*?)\*\*/g, '<strong class="text-primary">$1</strong>')
            .replace(/\n\n/g, '</p><p class="mb-3">')
            .replace(/\n/g, '<br>')
            .replace(/^(.*)$/, '<p class="mb-3 lead">$1</p>');
    }
    
    function formatSummary(summary) {
        // Convert markdown-like formatting to HTML
        return summary
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\n/g, '<br>')
            .replace(/üìã|üí°|üìö|üìñ|üè•|üíä|üî¨|üëÅÔ∏è|üö´/g, (emoji) => `<span class="fs-5">${emoji}</span>`);
    }
});
</script>

<style>
    #queryInput {
        border: 2px solid #dee2e6;
        font-size: 1.1rem;
    }
    
    #queryInput:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    .sample-query {
        font-size: 0.875rem;
        cursor: pointer;
    }
    
    .sample-query:hover {
        background-color: #0d6efd;
        color: white;
        border-color: #0d6efd;
    }
    
    .summary-content {
        font-size: 1.1rem;
        line-height: 1.8;
    }
    
    .accordion-button:not(.collapsed) {
        background-color: #e7f3ff;
        color: #0d6efd;
    }
    
    .list-group-item {
        border-left: 4px solid #198754;
    }
    
    .ai-answer-content {
        font-size: 1.15rem;
        line-height: 1.9;
        color: #2c3e50;
        background: linear-gradient(to right, #f8f9fa, #ffffff);
        padding: 1.5rem;
        border-radius: 8px;
        border-left: 5px solid #667eea;
    }
    
    .ai-answer-content p {
        margin-bottom: 1rem;
    }
    
    .ai-answer-content strong {
        color: #667eea;
        font-weight: 600;
    }
    
    .bg-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    }
</style>
{% endblock %}
